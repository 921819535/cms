<!DOCTYPE html>
<html>
<head>
    <title>所有栏目</title>
    $css()
    <style type="text/css">
        .panel{ margin: 1em;padding: 1em;background: #FFF;border: solid 1px #EEE;}
        table{ background: #FFF;}
        table .panel{ background: #F8F8F8;}
        .ctrl-panel{ text-align: right;padding-right: 2em;}
    </style>
</head>
<body>
<div>
    <table cellpadding="0" cellspacing="0" width="100%">
        <tr>
            <td width="50%" valign="top">
                <div class="panel">
                    <select id="site_selector">
                        <option value="">请选择</option>
                        ${site_opt}
                    </select>
                    <div id="from_tree"></div>
                </div>
            </td>
            <td valign ="top">
                <div class="panel">
                    目标站点：
                    <br />
                    ${target_name}
                    <div class="hidden" style="padding: 20px 20px 0 20px">
                        <input type="button" class="btn" value="新建栏目" id="btn_create" />&nbsp;
                        <input type="button" class="btn" value="收起栏目" id="btn_collage" />&nbsp;
                        <input type="button" class="btn" value="栏目助手" id="btn_utility" />
                    </div>
                    <div id="to_tree" style="padding: 20px"></div>
                </div>
            </td>
        </tr>
    </table>
</div>

<div class="panel ctrl-panel">
    <span id="tip-msg">还未选择栏目</span>
    <span class="ui-button w150">
        <span class="button-inner">
            <span class="button-txt">拷贝栏目</span>
            <a href="javascript:;"></a>
        </span>
    </span>
</div>

$js()
<script type="text/javascript">
    var siteId = ${target_site};
    var fromTreePanel = j6.$('from_tree');
    var toTreePanel = j6.$('to_tree');
    var tipMsg = j6.$('tip-msg');
    var fromNode = {};
    var toNode = {};
    var treeObj = null;

    j6.$('site_selector').onchange = function() {
        var fromSiteId = this.value;
        if (fromSiteId !== '') {
            loadFromCategoryTree(fromSiteId,fromTreePanel);
        }
    };


    //加载栏目树
    function loadFromCategoryTree(siteId, panel) {
        fromNode = {};
        reqTree(siteId, function(json) {
            treeObj = j6.tree.load(panel, json, '/framework/assets/tree/', function(a, d) {
                treeChecked(true,a,d);
            });
            var nodeLinks;
            j6.each(fromTreePanel.getElementsByTagName('DIV'), function(i, e) {
                if (e.className == 'node') {
                    nodeLinks = e.getElementsByClassName
                        ? e.getElementsByClassName('node')
                        : document.getElementsByClassName('node', e);
                }
            });
        });
    }

    function loadToCategoryTree() {
        reqTree(siteId, function(json) {
            j6.tree.load(toTreePanel, json, '/framework/assets/tree/', function(a, d) {
                treeChecked(false,a,d);
            });
        });
    }

    function reqTree(siteId, callback) {
        j6.xhr.request({
            uri: '?module=ajax&action=CategoryNodes&site_id='+siteId,
            method: 'GET',
            data: 'json'
        }, {
            success: function (json) {
                callback(json);
            }, error: function () {
                alert('栏目加载失败!');
            }
        });
    }

    function treeChecked(from,a, d) {
        a.className = 'node node-selelected';
        var json = j6.toJson(d);
        var node =  { id: json.cid, name: a.innerHTML };
        if (from) {
            fromNode = node;
        } else {
            toNode = node;
        }
        absMsg();
    }

    function absMsg() {
        if (fromNode.id == undefined) {
            tipMsg.innerHTML = '源栏目未选择!';
        }else if (toNode.id == undefined) {
            tipMsg.innerHTML = '目标上级栏目未选择';
        } else {
            tipMsg.innerHTML = j6.template('即将从<b>{fName}</b>拷贝到<b>{tName}</b>', {
                fName: fromNode.name,
                tName: toNode.name
            });
        }
    }


    //重新加载栏目树
    function _reloadTree() {
        if (parent._loadCategoryTree) parent._loadCategoryTree();
        if (window._thisLoadCategoryTree) window._thisLoadCategoryTree();
    }

    loadToCategoryTree();

    /*
    j6.$('btn_collage').onclick = function () {
        if (this.value.indexOf('收起') != -1) {
            treeObj.closeAll();
            this.value = '展开栏目';
        } else {
            treeObj.openAll();
            this.value = '收起栏目';
        }
    };*/
</script>

</body>
</html>
