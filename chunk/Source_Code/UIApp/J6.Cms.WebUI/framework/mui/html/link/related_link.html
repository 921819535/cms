<!DOCTYPE html>
<html>
<head>
    <title>所有链接</title>
    $css()
    $iconcss()
    <style type="text/css">
        .ui-autocompletion-panel{ border: solid 1px #ddd;border-top: 0px;color:#000000}
        .ui-autocompletion-panel .inner{ padding: 0px;}
        .ui-autocompletion-panel ul li {padding: 5px 10px; }
        .ui-autocompletion-panel ul li.first { border:none}
        .ui-autocompletion-panel ul li.selected {
            background: #f0f0f0;
        }
        .ui-autocompletion-panel ul li b{ color: green;}
    </style>
</head>
<body>
    <div class="tabarea">
        <div class="tab_mini">
            <a class="current" href="javascript:;">关联链接</a>
        </div>
        <div class="overhidden" id="relatedPanel">
            <table cellpadding="0" cellspacing="0" width="100%" height="100%">
                <tr>
                    <td width="350" valign="top">
                        <div id="dg" class="control"></div>
                        <div class="ui-table-meta" id="pager"></div>
                    </td>
                    <td valign="top">
                        <div id="pl" class="relative autoHeight autoScroll"></div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

<script type="text/template" id="link_form">
            
                    <div class="form">
                        
                        <div class="fl">
                            <div class="label">
                                <span class="red">*&nbsp;</span>关联类型：</div>
                            <div class="in">
                                <select name="RelatedIndent" class="ui-box" field="RelatedIndent">
                                    <option value="">-- 请选择 --</option>
                                    ${indent_opts}
                                </select>
                            </div>
                        </div>

                        <div class="fl">
                            <div class="label">
                                <span class="red">*&nbsp;</span>链接文档：
                            </div>
                            <div class="in">
                                <input class="ui-validate ui-box" type="hidden" field="Id" value="0" />
                                <input class="ui-validate ui-box" type="hidden" field="ContentType" value="${content_type}" />
                                <input class="ui-validate ui-box" type="hidden" field="ContentId" value="${content_id}" />
                                <input class="ui-validate ui-box" type="hidden" field="RelatedId" value="0" />
                                <input type="text" class="tb_normal ui-box archiveGuest" field="ContentTitle" />
                                <div>输入搜索内容后，在搜索结果中选择</div>
                            </div>
                        </div>
                        
                        <div class="fl">
                            <div class="label">
                                <span class="red">*&nbsp;</span>是否启用：
                            </div>
                            <div class="in">
                                <input type="radio" field="Enabled" name="Enabled" value="1" id="enabled1" checked="checked"/><label for="enabled1">启用</label>
                                <input type="radio" field="Enabled" name="Enabled" value="0" id="enabled2" /><label for="enabled2">停用</label>
                            </div>
                        </div>
                        
                        <div class="fl">
                            <div class="label">&nbsp;</div>
                            <div class="in">
                                <span class="ui-button w150" id="btn" onclick="saveData()">
                                    <span class="button-inner">
                                        <span class="button-txt">{btntext}</span>
                                        <a href="javascript:;"></a>
                                    </span>
                                </span>
                            </div>
                        </div>
                </div>
        </script>

        <script type="text/template" id="tpl">
            <div class="item" onclick="menu.add()">
                <a href="javascript:;">$icon(create)新建</a>
            </div>
   
            <div class="item" onclick="menu.del('%id%')">
                <a href="javascript:;">$icon(delete)删除</a>
            </div>
            <div class="item" onclick="menu.refresh()">
                <a href="javascript:;">$icon(refresh)刷新</a>
            </div>
        </script>$js()
    <script type="text/javascript">
        
        var dataCollection = null;
        var pl = j6.$('pl');

        j6.dom.fitHeight(j6.$('relatedPanel').parentNode);
        j6.dom.fitHeight(j6.$('relatedPanel'));

        var form_tpl = j6.$('link_form').innerHTML;

        

        window.saveData = function () {
            if (j6.validator.validate('pl')) {
                var data = j6.json.toObject('pl');
                j6.xhr.jsonPost('?module=link&action=save_related_link', data, function (json) {
                    if (json.result) {
                        _dg.reload();
                    }
                    parent.parent.M.alert(json.message);
                });
            }
        };

        var _dg = j6.grid('dg', {
            url: '?module=link&action=related_link',
            data: {
                ContentId:'${content_id}',
                ContentType: '${content_type}'
            },
            idField: 'LinkId',
            columns: [
                //{ field: 'ID', title: '编号', width: 100, formatter: null},
                { field: 'LinkName', title: '名称', width: 80, formatter: null },
                { field: 'LinkTitle', title: '标题', width: 120, formatter: null },
                { field: 'LinkUri', title: '链接地址', formatter: null }
            ],
            loaded: function (data) {

                dataCollection = data.rows;

                var tables = document.getElementsByTagName('TABLE');

                var tds = tables[2].getElementsByTagName('TD');

                var allowMultSelect = false;

                j6.table.dynamic(tables[2], allowMultSelect, function (trs) {
                    var id = trs[0].getAttribute('data-indent');
                    pl.innerHTML = j6.template(form_tpl, { btntext: '保存' });
                    pl.getElementsByTagName('DL')[0].style.display = 'none';
                    for (var i = 0; i < dataCollection.length; i++) {
                        if (dataCollection[i].LinkId == id) {
                            j6.json.bind(pl, {
                                LinkId: id,
                                LinkName: dataCollection[i].LinkName,
                                LinkUri: dataCollection[i].LinkUri,
                                LinkTitle: dataCollection[i].LinkTitle,
                                Enabled: dataCollection[i] ? 'True' : 'False'
                            });
                        }
                    }

                    //
                });

                j6.each(tds, function (i, e) {
                    j6.contextmenu.bind(e, null, function (menu) {
                        menu.innerHTML = j6.template(j6.$('tpl').innerHTML, {
                            id: e.parentNode.getAttribute('data-indent')
                        });
                    });
                });


                //加载分页
                this.panel.nextSibling.innerHTML = data.pager;

            }
        });


        var menu = {
            add: function() {
                j6.$('pl').innerHTML = j6.template(form_tpl, { btntext: '新增' });
                j6.json.bind('pl', { Enabled: true });

                j6.each(j6.dom.getsByClass(j6.$('pl'), 'archiveGuest'), function (i, e) {
                    j6.autoCompletion(e, '?module=ajax&action=GetSearchArchivesJsonResult&size=10', function (data) {
                        j6.json.bind('pl', { RelatedId: 0 });
                        for (var j = 0; j < data.length; j++) {
                            data[j].text = data[j].title;
                            data[j].title = '栏目：'+ data[j].category;
                        }
                    }, function (data) {
                        j6.json.bind('pl', { RelatedId: data.id });
                    });
                });
            },
            del: function (id) {
                if (confirm('确定删除吗?删除后将不可恢复!')) {
                    var data = {
                        id: id,
                        content_id: j6.request('content_id'),
                        type_indent: j6.request('type')
                    };
                    j6.xhr.jsonPost('?module=link&action=delete_related_link', data,
                        function (json) {
                            if (json.result) {
                                _dg.reload();
                            } else {showErr(json.message); }
                        });
                }
            },
            refresh: function () {
                _dg.reload();
            }
        };

        menu.add();
         
    </script>

</body>
</html>
